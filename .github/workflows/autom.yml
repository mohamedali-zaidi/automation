name: Jira Notification and Approval Workflow

on:
  repository_dispatch:
    types: [jira_webhook]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Debug Webhook Data
      - name: Debug Webhook Data
        run: |
          echo "Webhook data received: ${{ toJson(github.event.client_payload) }}"

      # Step 2: Debug Individual Fields
      - name: Debug Individual Fields
        run: |
          echo "Issue Summary: '${{ github.event.client_payload.issue.fields.summary }}'"
          echo "Assigned Developer: '${{ github.event.client_payload.issue.fields.assignee.displayName }}'"
          echo "Due Date: '${{ github.event.client_payload.issue.fields.duedate }}'"
          echo "Status: '${{ github.event.client_payload.issue.fields.status.name }}'"

      # Step 3: Check if Status is "Awaiting Approval"
      - name: Check for "Awaiting Approval" Status
        if: ${{ github.event.client_payload.issue.fields.status.name == 'Awaiting for Approval' }}
        run: echo "Status is Awaiting Approval, proceeding to send Adaptive Card."

      # Step 4: Send an Adaptive Card for Approval to MS Teams (only if the status is "Awaiting Approval")
      - name: Send Adaptive Card for Approval
        if: ${{ github.event.client_payload.issue.fields.status.name == 'Awaiting Approval' }}
        run: |
          ISSUE_KEY="${{ github.event.client_payload.issue.key }}"
          ISSUE_SUMMARY=$(echo "${{ github.event.client_payload.issue.fields.summary }}" | sed 's/"/\\"/g')

          # Construct the Adaptive Card JSON payload
          ADAPTIVE_CARD_PAYLOAD=$(cat <<EOF
          {
            "type": "message",
            "attachments": [
              {
                "contentType": "application/vnd.microsoft.card.adaptive",
                "content": {
                  "\$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "type": "AdaptiveCard",
                  "version": "1.3",
                  "body": [
                    {
                      "type": "TextBlock",
                      "text": "Approval Required for Issue: $ISSUE_SUMMARY",
                      "weight": "Bolder",
                      "size": "Medium"
                    },
                    {
                      "type": "TextBlock",
                      "text": "[View Issue](https://mohamedalizaidi48.atlassian.net/browse/$ISSUE_KEY)",
                      "wrap": true
                    }
                  ],
                  "actions": [
                    {
                      "type": "Action.Submit",
                      "title": "Approve",
                      "data": {
                        "action": "approve",
                        "issueKey": "$ISSUE_KEY"
                      }
                    },
                    {
                      "type": "Action.Submit",
                      "title": "Reject",
                      "data": {
                        "action": "reject",
                        "issueKey": "$ISSUE_KEY"
                      }
                    }
                  ]
                }
              }
            ]
          }
          EOF
          )

          # Send the Adaptive Card to MS Teams
          curl -H "Content-Type: application/json" -d "$ADAPTIVE_CARD_PAYLOAD" ${{ secrets.TEAMS_WEBHOOK_URL }}
